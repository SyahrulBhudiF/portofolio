---
import ThemeToggle from "./ThemeToggle";
---

<div
    id="top-bar"
    class="fixed top-0 left-0 right-0 z-40 py-3 px-4 sm:px-6 transition-all duration-300"
>
    <div class="max-w-[1100px] mx-auto">
        <a
            href="#home"
            class="inline-block w-9 h-9 hover:opacity-80 transition-opacity"
            aria-label="Home"
        >
            <svg
                viewBox="0 0 300 300"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                class="w-full h-full"
            >
                <path
                    d="M62.5 183.25C61.75 179.25 58.5 169.5 56 164.25C65.25 163 76.75 157.5 93 148.75C110.75 140 166.25 106.25 208.75 68.75L225.75 81.5C178 121.25 126.5 152.5 77.25 174.5V175C77.25 175 62.5 179.25 62.5 183.25ZM62.5 183.25L62 168.25L75.5 161L222 150.5C219.25 155.5 216.5 163.75 215.25 167.75C85.25 178 71.5 179.75 62.5 183.25ZM70.5 120.75C69.5 116.75 66.5 107 64.5 101.75C70.5 100.75 77.5 96.25 86.5 90C96.25 83.25 127.5 58 150 32L167.5 43C141.5 69.5 112.25 94 84.25 110.75V111.25C84.25 111.25 70.5 116.75 70.5 120.75ZM70.5 120.75L70 106.75L81.25 100.75L183.75 93.75C182 98.75 180.5 105.75 180.25 109.75C87.5 116.75 77.25 118.25 70.5 120.75ZM227.5 127L248 133.75C214 210.25 146.5 243.25 53.25 260.5C51.5 255.25 46.25 246 42.75 241.25C134.25 227.5 199 197 227.5 127Z"
                    fill="var(--iris)"></path>
            </svg>
        </a>
    </div>
</div>

<nav
    id="side-nav"
    class="fixed right-0 top-1/2 -translate-y-1/2 z-50"
    aria-label="Main navigation"
>
    <div
        class="nav-container flex flex-col gap-0.5 sm:gap-1 p-1.5 sm:p-2 rounded-l-xl sm:rounded-l-2xl bg-[var(--surface)]/90 backdrop-blur-xl border border-r-0 border-[var(--highlight-low)] shadow-lg transition-all duration-300"
    >
        <a
            href="#home"
            class="nav-item group relative flex items-center justify-end gap-3 px-2 sm:px-3 py-2 sm:py-2.5 rounded-lg sm:rounded-xl transition-all duration-200"
            aria-label="Home"
            data-section="home"
        >
            <span
                class="nav-label absolute right-full mr-2 sm:mr-3 px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg bg-[var(--surface)] border border-[var(--highlight-low)] text-xs sm:text-sm font-medium text-[var(--text)] opacity-0 translate-x-2 pointer-events-none transition-all duration-200 whitespace-nowrap shadow-lg"
            >
                Home
            </span>
            <svg
                class="nav-icon w-4 h-4 sm:w-5 sm:h-5 text-[var(--muted)] group-hover:text-[var(--iris)] transition-colors"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                ></path>
            </svg>
        </a>

        <a
            href="#about"
            class="nav-item group relative flex items-center justify-end gap-3 px-2 sm:px-3 py-2 sm:py-2.5 rounded-lg sm:rounded-xl transition-all duration-200"
            aria-label="About"
            data-section="about"
        >
            <span
                class="nav-label absolute right-full mr-2 sm:mr-3 px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg bg-[var(--surface)] border border-[var(--highlight-low)] text-xs sm:text-sm font-medium text-[var(--text)] opacity-0 translate-x-2 pointer-events-none transition-all duration-200 whitespace-nowrap shadow-lg"
            >
                About
            </span>
            <svg
                class="nav-icon w-4 h-4 sm:w-5 sm:h-5 text-[var(--muted)] group-hover:text-[var(--iris)] transition-colors"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                ></path>
            </svg>
        </a>

        <a
            href="#projects"
            class="nav-item group relative flex items-center justify-end gap-3 px-2 sm:px-3 py-2 sm:py-2.5 rounded-lg sm:rounded-xl transition-all duration-200"
            aria-label="Projects"
            data-section="projects"
        >
            <span
                class="nav-label absolute right-full mr-2 sm:mr-3 px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg bg-[var(--surface)] border border-[var(--highlight-low)] text-xs sm:text-sm font-medium text-[var(--text)] opacity-0 translate-x-2 pointer-events-none transition-all duration-200 whitespace-nowrap shadow-lg"
            >
                Projects
            </span>
            <svg
                class="nav-icon w-4 h-4 sm:w-5 sm:h-5 text-[var(--muted)] group-hover:text-[var(--iris)] transition-colors"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                ></path>
            </svg>
        </a>

        <a
            href="#experience"
            class="nav-item group relative flex items-center justify-end gap-3 px-2 sm:px-3 py-2 sm:py-2.5 rounded-lg sm:rounded-xl transition-all duration-200"
            aria-label="Experience"
            data-section="experience"
        >
            <span
                class="nav-label absolute right-full mr-2 sm:mr-3 px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg bg-[var(--surface)] border border-[var(--highlight-low)] text-xs sm:text-sm font-medium text-[var(--text)] opacity-0 translate-x-2 pointer-events-none transition-all duration-200 whitespace-nowrap shadow-lg"
            >
                Experience
            </span>
            <svg
                class="nav-icon w-4 h-4 sm:w-5 sm:h-5 text-[var(--muted)] group-hover:text-[var(--iris)] transition-colors"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                ></path>
            </svg>
        </a>

        <div class="w-full h-px bg-[var(--highlight-low)] my-0.5 sm:my-1"></div>

        <div class="flex justify-center py-0.5 sm:py-1">
            <ThemeToggle client:load />
        </div>
    </div>

    <button
        id="nav-toggle"
        type="button"
        class="nav-edge absolute right-0 top-1/2 -translate-y-1/2 flex flex-col items-center justify-center gap-1 sm:gap-1.5 p-2 sm:p-2.5 rounded-l-lg bg-[var(--surface)]/80 border border-r-0 border-[var(--highlight-low)] transition-all duration-300 cursor-pointer"
        aria-label="Toggle navigation menu"
    >
        <div class="w-1 h-1 rounded-full bg-[var(--iris)]"></div>
        <div class="w-1 h-1 rounded-full bg-[var(--iris)]/60"></div>
        <div class="w-1 h-1 rounded-full bg-[var(--iris)]"></div>
    </button>
</nav>

<style>
    .top-bar-scrolled {
        background-color: color-mix(in srgb, var(--base) 90%, transparent);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--highlight-low);
    }

    #side-nav .nav-container {
        transform: translateX(calc(100% + 4px));
        opacity: 0;
        pointer-events: none;
    }

    #side-nav.nav-open .nav-container {
        transform: translateX(0);
        opacity: 1;
        pointer-events: auto;
    }

    #side-nav .nav-edge {
        opacity: 1;
        transform: translateX(0);
    }

    #side-nav.nav-open .nav-edge {
        opacity: 0;
        transform: translateX(100%);
        pointer-events: none;
    }

    .nav-item.active .nav-icon {
        color: var(--iris);
        filter: drop-shadow(0 0 6px var(--iris));
    }

    @media (hover: hover) and (pointer: fine) {
        .nav-item:hover .nav-label {
            opacity: 1;
            transform: translateX(0);
        }

        #side-nav:hover .nav-container {
            transform: translateX(0);
            opacity: 1;
            pointer-events: auto;
        }

        #side-nav:hover .nav-edge {
            opacity: 0;
            transform: translateX(100%);
            pointer-events: none;
        }
    }

    @media (hover: none) or (pointer: coarse) {
        #side-nav.nav-open .nav-label {
            opacity: 1;
            transform: translateX(0);
        }
    }
</style>

<script>
    const topBar = document.getElementById("top-bar");

    const handleTopBarScroll = () => {
        if (window.scrollY > 50) {
            topBar?.classList.add("top-bar-scrolled");
        } else {
            topBar?.classList.remove("top-bar-scrolled");
        }
    };

    handleTopBarScroll();
    window.addEventListener("scroll", handleTopBarScroll, { passive: true });

    const sideNav = document.getElementById("side-nav");
    const navToggle = document.getElementById("nav-toggle");
    const navContainer = sideNav?.querySelector(".nav-container");
    const navItems = document.querySelectorAll(".nav-item");

    let isOpen = false;
    let hideTimeout: ReturnType<typeof setTimeout> | null = null;

    const openNav = () => {
        isOpen = true;
        sideNav?.classList.add("nav-open");
        if (hideTimeout) clearTimeout(hideTimeout);
    };

    const closeNav = () => {
        isOpen = false;
        sideNav?.classList.remove("nav-open");
    };

    const toggleNav = () => {
        if (isOpen) {
            closeNav();
        } else {
            openNav();
        }
    };

    navToggle?.addEventListener("click", (e) => {
        e.stopPropagation();
        toggleNav();
    });

    document.addEventListener("click", (e) => {
        const target = e.target as HTMLElement;
        if (isOpen && !target.closest("#side-nav")) {
            closeNav();
        }
    });

    navItems.forEach((item) => {
        item.addEventListener("click", () => {
            // Small delay so the navigation happens first
            setTimeout(() => {
                closeNav();
            }, 100);
        });
    });

    document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && isOpen) {
            closeNav();
        }
    });

    const isDesktop = window.matchMedia("(hover: hover) and (pointer: fine)");

    if (isDesktop.matches) {
        sideNav?.addEventListener("mouseleave", () => {
            hideTimeout = setTimeout(() => {
                closeNav();
            }, 300);
        });

        sideNav?.addEventListener("mouseenter", () => {
            if (hideTimeout) clearTimeout(hideTimeout);
        });
    }

    const sections = document.querySelectorAll("section[id]");

    const highlightNavOnScroll = () => {
        const scrollY = window.scrollY;
        const windowHeight = window.innerHeight;

        let currentSection = "";

        sections.forEach((section) => {
            const sectionElement = section as HTMLElement;
            const sectionTop = sectionElement.offsetTop - windowHeight / 3;
            const sectionHeight = sectionElement.offsetHeight;
            const sectionId = section.getAttribute("id") || "";

            if (scrollY >= sectionTop && scrollY < sectionTop + sectionHeight) {
                currentSection = sectionId;
            }
        });

        navItems.forEach((item) => {
            const itemSection = item.getAttribute("data-section");
            if (itemSection === currentSection) {
                item.classList.add("active");
            } else {
                item.classList.remove("active");
            }
        });
    };

    highlightNavOnScroll();
    window.addEventListener("scroll", highlightNavOnScroll, { passive: true });
</script>
